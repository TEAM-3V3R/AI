import os
import re
import logging
from pathlib import Path
from typing import List, Tuple

# GPU ë¹„í™œì„±í™” (libdevice ì´ìŠˆ íšŒí”¼)
os.environ["CUDA_VISIBLE_DEVICES"] = ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0) ë„ì–´ì“°ê¸° êµì •ê¸° (ì˜µì…˜)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    from pykospacing import Spacing
    spacing = Spacing()
except Exception:
    spacing = None
    logging.warning("[preprocessor] pykospacing ë¯¸ì„¤ì¹˜ â†’ ë„ì–´ì“°ê¸° êµì • ê±´ë„ˆëœ€")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ê²½ë¡œ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# .../AI/prompt_analyzer/preprocessor.py  â†’ BASE_DIR = .../AI
BASE_DIR: Path = Path(__file__).resolve().parents[1]
STOPWORDS_PATH: Path = BASE_DIR / "DPDT" / "data" / "stopwords.txt"
MECAB_DIC_DIR: Path = (BASE_DIR / "DPDT" / "mecab-ko-dic").resolve()

# MECABRCëŠ” Windowsì—ì„œ ê°•ì œë¡œ /etc/... ì§€ì •í•˜ì§€ ì•ŠìŒ
# os.environ["MECABRC"] = "/etc/mecabrc"  # ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) í˜•íƒœì†Œ ë¶„ì„ê¸° ë¡œë”© (MeCab â†’ ì‹¤íŒ¨ ì‹œ Okt)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TAGGER_NAME = None
tagger = None

try:
    from konlpy.tag import Mecab

    if MECAB_DIC_DIR.exists():
        dicpath = str(MECAB_DIC_DIR).replace("\\", "/")  # ê²½ë¡œ ì •ê·œí™”
        tagger = Mecab(dicpath=dicpath)
        TAGGER_NAME = f"mecab@{dicpath}"
    else:
        # ì‹œìŠ¤í…œ ê¸°ë³¸ ì‚¬ì „ìœ¼ë¡œ ì‹œë„
        tagger = Mecab()
        TAGGER_NAME = "mecab(default)"

except Exception as e:
    logging.warning(f"[preprocessor] Mecab ì´ˆê¸°í™” ì‹¤íŒ¨: {e} â†’ Oktë¡œ í´ë°±")
    try:
        from konlpy.tag import Okt
        tagger = Okt()
        TAGGER_NAME = "okt"
    except Exception as e2:
        raise RuntimeError(
            "í˜•íƒœì†Œ ë¶„ì„ê¸°ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Mecab/Okt ëª¨ë‘ ì‹¤íŒ¨)"
        ) from e2

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ë¶ˆìš©ì–´/í•„í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STOP_POS = {
    "JKS","JKC","JKO","JKB","JX","JC","JKG",   # ì¡°ì‚¬
    "EF","EC","EP","ETN","ETM",                # ì–´ë¯¸
    "SF","SE","SP","SS","SO",                  # ê¸°í˜¸
    "XSN","XSV"                                # ì ‘ë¯¸ì‚¬/ì ‘ì†
}

if STOPWORDS_PATH.exists():
    with STOPWORDS_PATH.open(encoding="utf-8") as f:
        WORD_STOP = {w.strip() for w in f if w.strip() and not w.startswith("#")}
else:
    WORD_STOP = set()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) í…ìŠ¤íŠ¸ ì •ë¦¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def clean_text(text: str) -> str:
    """
    1) ë„ì–´ì“°ê¸° ë³´ì •(ê°€ëŠ¥ ì‹œ)
    2) í•œê¸€/ê³µë°±ë§Œ ìœ ì§€
    3) ì—°ì† ê³µë°± ì •ë¦¬
    """
    if spacing:
        try:
            text = spacing(text)
        except Exception as e:
            logging.warning(f"[clean_text] spacing failed: {e}")  # ì›ë¬¸ ìœ ì§€

    text = re.sub(r"[^ê°€-í£\s]", " ", text)
    return re.sub(r"\s+", " ", text).strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) í˜•íƒœì†Œ ë¶„ì„ + í•„í„°ë§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _pos_mecab(s: str) -> List[Tuple[str, str]]:
    return tagger.pos(s)

def _pos_okt(s: str) -> List[Tuple[str, str]]:
    # (Okt ì¸ìŠ¤í„´ìŠ¤ë„ tagger ë³€ìˆ˜ì— ë“¤ì–´ ìˆìœ¼ë¯€ë¡œ ë™ì¼ í˜¸ì¶œ)
    return tagger.pos(s)

COMMON_VERBS = {"í•˜ë‹¤", "ë˜ë‹¤", "ìˆë‹¤", "ì—†ë‹¤", "ê°™ë‹¤", "ì´ë‹¤"}

def extract_morphs(text: str):
    s = clean_text(text)
    pairs = tagger.pos(s)

    result = []
    for w, pos in pairs:
        if not w:
            continue
        if len(w) == 1:   # ğŸ”¹ í•œ ê¸€ì í† í° ì œê±°
            continue
        if w in WORD_STOP:
            continue
        if pos in STOP_POS:
            continue
        if w in COMMON_VERBS:  # ğŸ”¹ ì˜ë¯¸ ì—†ëŠ” ì¼ë°˜ ë™ì‚¬ ì œê±°
            continue
        result.append((w, pos))
    return result


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) í…ŒìŠ¤íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    demo = "ê°€ë””ê±´ì„ì…ê³ ë¬´í‘œì •í•˜ê²Œì •ë©´ì„ë°”ë¼ë³´ëŠ”ì²­ë…„ ì…ë‹ˆë‹¤."
    print(f"[tagger={TAGGER_NAME}]")
    print("[raw    ]", demo)
    print("[cleaned]", clean_text(demo))
    print("[morphs ]", extract_morphs(demo))
